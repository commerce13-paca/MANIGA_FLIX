<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Holdest Odyssey - Aventure de survie réelle en collaboration">
  <title>Holdest Odyssey - Aventure Réelle</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
  
  <style>
    :root {
      --primary-color: #00ff99;
      --primary-dark: #00cc77;
      --secondary-color: #1a2a6c;
      --accent-color: #fdbb2d;
      --danger-color: #b21f1f;
      --dark-bg: #000;
      --dark-secondary: #003300;
      --light-text: #fff;
      --medium-text: #ccc;
      --dark-text: #333;
      --card-bg: rgba(255, 255, 255, 0.05);
      --border-radius: 15px;
      --transition: all 0.3s ease;
      --shadow: 0 4px 8px rgba(0,0,0,0.6);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, var(--dark-bg), var(--dark-secondary));
      color: var(--light-text);
      min-height: 100vh;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    /* Page publique (non connecté) */
    .public-app {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 40px 20px;
    }

    .public-hero {
      max-width: 800px;
    }

    .public-hero h1 {
      font-size: 4rem;
      margin-bottom: 20px;
      background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .public-hero p {
      font-size: 1.3rem;
      margin-bottom: 40px;
      color: var(--medium-text);
    }

    .public-features {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 30px;
      margin: 50px 0;
    }

    .feature-card {
      background: var(--card-bg);
      padding: 30px;
      border-radius: var(--border-radius);
      text-align: center;
    }

    .feature-icon {
      font-size: 3rem;
      color: var(--primary-color);
      margin-bottom: 20px;
    }

    /* Application privée (connecté) */
    .private-app {
      display: none;
    }

    /* Header avec info utilisateur */
    header {
      padding: 20px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: 2px solid var(--primary-color);
      object-fit: cover;
    }

    .user-details {
      text-align: right;
    }

    .user-name {
      font-weight: 600;
      color: var(--primary-color);
    }

    .user-level {
      font-size: 0.9rem;
      color: var(--medium-text);
    }

    /* Navigation */
    .main-nav {
      background: rgba(0,0,0,0.3);
      padding: 15px 0;
      margin: 20px 0;
    }

    .nav-links {
      display: flex;
      justify-content: center;
      gap: 30px;
      list-style: none;
    }

    .nav-links a {
      color: var(--light-text);
      text-decoration: none;
      padding: 10px 20px;
      border-radius: 25px;
      transition: var(--transition);
    }

    .nav-links a.active {
      background: var(--primary-color);
      color: var(--dark-text);
    }

    .nav-links a:hover {
      background: rgba(0,255,153,0.2);
    }

    /* Sections principales */
    .section {
      display: none;
      padding: 40px 0;
    }

    .section.active {
      display: block;
    }

    /* Page d'accueil connecté */
    .hero {
      text-align: center;
      padding: 60px 0;
    }

    .hero h1 {
      font-size: 3.5rem;
      margin-bottom: 20px;
      background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .hero-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 40px 0;
    }

    .stat-card {
      background: var(--card-bg);
      padding: 20px;
      border-radius: var(--border-radius);
      text-align: center;
    }

    .stat-number {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 10px;
    }

    /* Missions et étapes */
    .missions-container {
      max-width: 1000px;
      margin: 0 auto;
    }

    .mission-progress {
      background: var(--card-bg);
      padding: 20px;
      border-radius: var(--border-radius);
      margin-bottom: 30px;
    }

    .progress-bar {
      height: 10px;
      background: #333;
      border-radius: 5px;
      overflow: hidden;
      margin: 15px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
      width: 0%;
      transition: width 1s ease;
    }

    .mission-steps {
      display: flex;
      justify-content: space-between;
      position: relative;
      margin: 40px 0;
    }

    .mission-steps::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 0;
      right: 0;
      height: 3px;
      background: #333;
      z-index: 1;
    }

    .mission-step {
      text-align: center;
      position: relative;
      z-index: 2;
      flex: 1;
    }

    .step-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #333;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 10px;
      transition: var(--transition);
    }

    .step-icon.active {
      background: var(--primary-color);
      color: var(--dark-text);
    }

    .step-icon.completed {
      background: var(--accent-color);
      color: var(--dark-text);
    }

    .mission-content {
      background: var(--card-bg);
      padding: 30px;
      border-radius: var(--border-radius);
      margin: 30px 0;
    }

    .mission-image {
      width: 100%;
      height: 300px;
      object-fit: cover;
      border-radius: var(--border-radius);
      margin: 20px 0;
    }

    .mission-instructions {
      background: rgba(0,0,0,0.3);
      padding: 20px;
      border-radius: var(--border-radius);
      margin: 20px 0;
    }

    /* Participants */
    .participants-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }

    .participant-card {
      background: var(--card-bg);
      padding: 15px;
      border-radius: var(--border-radius);
      text-align: center;
      transition: var(--transition);
    }

    .participant-card:hover {
      transform: translateY(-5px);
    }

    .participant-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      margin: 0 auto 10px;
      border: 2px solid var(--primary-color);
    }

    /* Commerces partenaires */
    .partners-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 30px;
      margin: 30px 0;
    }

    .partner-card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      overflow: hidden;
      transition: var(--transition);
    }

    .partner-card:hover {
      transform: translateY(-5px);
    }

    .partner-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }

    .partner-info {
      padding: 20px;
    }

    .partner-badge {
      background: var(--accent-color);
      color: var(--dark-text);
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-block;
      margin-bottom: 10px;
    }

    /* Boutons */
    .btn {
      padding: 12px 30px;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      text-align: center;
      font-family: 'Poppins', sans-serif;
    }

    .btn-primary {
      background: var(--primary-color);
      color: var(--dark-text);
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-secondary {
      background: transparent;
      border: 2px solid var(--primary-color);
      color: var(--primary-color);
    }

    .btn-secondary:hover {
      background: rgba(0,255,153,0.1);
    }

    .btn-google {
      background: #ffffff;
      color: #333;
      border: 2px solid #ddd;
    }

    .btn-google:hover {
      background: #f5f5f5;
      border-color: #ccc;
    }

    .btn-large {
      padding: 15px 40px;
      font-size: 1.1rem;
    }

    /* Popups */
    .popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .popup-content {
      background: #111;
      padding: 30px;
      border-radius: var(--border-radius);
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }

    /* Formulaire */
    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: var(--medium-text);
    }

    .form-group input {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #333;
      background: #222;
      color: var(--light-text);
      font-family: 'Poppins', sans-serif;
    }

    /* Messages */
    .message {
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: center;
    }

    .message.success {
      background: rgba(0,255,153,0.2);
      border: 1px solid var(--primary-color);
    }

    .message.error {
      background: rgba(178,31,31,0.2);
      border: 1px solid var(--danger-color);
    }

    /* Toast notifications */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 10px;
      color: white;
      z-index: 1001;
      display: flex;
      align-items: center;
      gap: 10px;
      transform: translateX(150%);
      transition: transform 0.3s ease;
      max-width: 400px;
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast.success {
      background: var(--primary-color);
      color: var(--dark-text);
    }

    .toast.error {
      background: var(--danger-color);
    }

    .toast.info {
      background: var(--secondary-color);
    }

    /* Loader */
    .loader {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Défi final - Mode survie */
    .survival-challenge {
      background: rgba(0,40,0,0.7);
      padding: 30px;
      border-radius: var(--border-radius);
      margin: 30px 0;
    }

    .survival-resources {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .resource-item {
      background: rgba(0,80,0,0.3);
      padding: 15px;
      border-radius: var(--border-radius);
      text-align: center;
    }

    .resource-count {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--primary-color);
      margin: 10px 0;
    }

    /* QR Code Scanner */
    .qr-scanner {
      text-align: center;
      margin: 20px 0;
    }

    .qr-placeholder {
      width: 200px;
      height: 200px;
      background: #333;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      font-size: 3rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .public-hero h1 {
        font-size: 2.5rem;
      }

      .header-content {
        flex-direction: column;
        gap: 15px;
      }

      .nav-links {
        flex-wrap: wrap;
        gap: 10px;
      }

      .hero h1 {
        font-size: 2.5rem;
      }

      .participants-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      }

      .toast {
        left: 20px;
        right: 20px;
        max-width: calc(100% - 40px);
      }

      .mission-steps {
        flex-direction: column;
        gap: 20px;
      }

      .mission-steps::before {
        display: none;
      }
    }
  </style>
</head>
<body>
  <!-- Application publique (non connecté) -->
  <div id="publicApp" class="public-app">
    <div class="public-hero">
      <h1>Holdest Odyssey</h1>
      <p>L'aventure de survie réelle qui transforme votre ville en terrain de jeu</p>
      
      <div class="public-features">
        <div class="feature-card">
          <div class="feature-icon">
            <i class="fas fa-map-marked-alt"></i>
          </div>
          <h3>Exploration Urbaine</h3>
          <p>Découvrez des lieux emblématiques et récupérez des objets essentiels</p>
        </div>
        <div class="feature-card">
          <div class="feature-icon">
            <i class="fas fa-store"></i>
          </div>
          <h3>Commerces Partenaires</h3>
          <p>Collaborez avec des commerces locaux pour vos ressources</p>
        </div>
        <div class="feature-card">
          <div class="feature-icon">
            <i class="fas fa-users"></i>
          </div>
          <h3>Communauté</h3>
          <p>Rejoignez une communauté d'aventuriers passionnés</p>
        </div>
      </div>

      <button class="btn btn-primary btn-large" onclick="showAuthPopup()">
        Commencer l'Aventure
      </button>
    </div>
  </div>

  <!-- Application privée (connecté) -->
  <div id="privateApp" class="private-app">
    <!-- Header avec informations utilisateur -->
    <header id="header">
      <div class="header-content">
        <div class="logo">
          <h2>Holdest Odyssey</h2>
        </div>
        <div class="user-info">
          <img id="userAvatar" class="user-avatar" src="" alt="Avatar">
          <div class="user-details">
            <div id="userName" class="user-name"></div>
            <div id="userLevel" class="user-level">Niveau 1 - 0 points</div>
          </div>
          <button id="logoutBtn" class="btn btn-secondary">Déconnexion</button>
        </div>
      </div>
    </header>

    <!-- Navigation principale -->
    <nav class="main-nav">
      <ul class="nav-links">
        <li><a href="#" class="nav-link active" data-section="home">Accueil</a></li>
        <li><a href="#" class="nav-link" data-section="missions">Mes Missions</a></li>
        <li><a href="#" class="nav-link" data-section="participants">Participants</a></li>
        <li><a href="#" class="nav-link" data-section="commerce">Commerces</a></li>
        <li><a href="#" class="nav-link" data-section="profile">Mon Profil</a></li>
      </ul>
    </nav>

    <div class="container">
      <!-- Section d'accueil -->
      <section id="home" class="section active">
        <div class="hero">
          <h1>Bienvenue dans l'Aventure !</h1>
          <p>Votre odyssée de survie urbaine commence maintenant</p>
          
          <div class="hero-stats">
            <div class="stat-card">
              <div class="stat-number" id="totalParticipants">0</div>
              <div>Aventuriers en course</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="missionsCompleted">0</div>
              <div>Missions accomplies</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="daysRemaining">7</div>
              <div>Jours restants</div>
            </div>
          </div>

          <div style="margin-top: 30px;">
            <button class="btn btn-primary btn-large" onclick="showSection('missions')">
              Voir mes Missions
            </button>
            <button class="btn btn-secondary" onclick="showSection('commerce')">
              Explorer les Commerces
            </button>
          </div>
        </div>
      </section>

      <!-- Section Missions -->
      <section id="missions" class="section">
        <h2>Mon Parcours d'Aventure</h2>
        <p>Suivez votre progression dans l'odyssée Holdest</p>
        
        <div class="missions-container">
          <div class="mission-progress">
            <h3>Progression Générale</h3>
            <div class="progress-bar">
              <div class="progress-fill" id="globalProgress"></div>
            </div>
            <div id="progressText">0% complété</div>
          </div>

          <div class="mission-steps">
            <div class="mission-step">
              <div class="step-icon active" id="step1Icon">1</div>
              <div>Sac à Dos</div>
              <small>Vieux Port</small>
            </div>
            <div class="mission-step">
              <div class="step-icon" id="step2Icon">2</div>
              <div>Couteau</div>
              <small>Magasin</small>
            </div>
            <div class="mission-step">
              <div class="step-icon" id="step3Icon">3</div>
              <div>Eau</div>
              <small>Supermarché</small>
            </div>
            <div class="mission-step">
              <div class="step-icon" id="step4Icon">4</div>
              <div>Nourriture</div>
              <small>Boucherie</small>
            </div>
            <div class="mission-step">
              <div class="step-icon" id="step5Icon">5</div>
              <div>Survie</div>
              <small>Final</small>
            </div>
          </div>

          <div class="mission-content" id="missionContent">
            <!-- Le contenu de la mission actuelle sera injecté ici -->
          </div>
        </div>
      </section>

      <!-- Section Participants -->
      <section id="participants" class="section">
        <h2>Les Aventuriers</h2>
        <p>Rencontrez les autres participants de Holdest Odyssey</p>
        
        <div class="participants-grid" id="participantsGrid">
          <!-- Les participants seront chargés dynamiquement -->
        </div>
      </section>

      <!-- Section Commerces -->
      <section id="commerce" class="section">
        <h2>Commerces Partenaires</h2>
        <p>Collaborez avec nos commerces locaux pour récupérer des ressources</p>
        
        <div class="partners-grid" id="partnersGrid">
          <!-- Les commerces seront chargés dynamiquement -->
        </div>
      </section>

      <!-- Section Profil -->
      <section id="profile" class="section">
        <h2>Mon Profil d'Aventurier</h2>
        
        <div class="profile-content">
          <div class="avatar-selection">
            <h3>Choisissez votre Avatar</h3>
            <div class="avatar-grid" id="avatarGrid">
              <!-- Les avatars seront ajoutés dynamiquement -->
            </div>
          </div>

          <div class="profile-info">
            <h3>Informations Personnelles</h3>
            <div class="form-group">
              <label>Nom d'aventurier</label>
              <input type="text" id="displayName" placeholder="Votre nom d'aventurier">
            </div>
            <button class="btn btn-primary" onclick="updateProfile()">Mettre à jour le profil</button>
          </div>

          <div class="inventory">
            <h3>Mon Inventaire</h3>
            <div class="inventory-grid" id="inventoryGrid">
              <!-- L'inventaire sera chargé dynamiquement -->
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Popup d'authentification -->
  <div id="authPopup" class="popup">
    <div class="popup-content">
      <h2>Bienvenue sur Holdest Odyssey</h2>
      <p>Rejoignez l'aventure de survie réelle</p>
      
      <div id="loginForm">
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="loginEmail" placeholder="votre@email.com">
        </div>
        <div class="form-group">
          <label>Mot de passe</label>
          <input type="password" id="loginPassword" placeholder="Votre mot de passe">
        </div>
        <button class="btn btn-primary" id="loginBtn" onclick="login()">
          <span id="loginText">Se connecter</span>
          <span id="loginLoader" class="loader" style="display: none;"></span>
        </button>
        <div class="separator">
          <span>ou</span>
        </div>
        <button class="btn btn-google" onclick="loginWithGoogle()">
          <i class="fab fa-google"></i>
          Se connecter avec Google
        </button>
        <button class="btn btn-secondary" onclick="showRegisterForm()">Créer un compte</button>
        <div id="authMessage" class="message" style="display: none;"></div>
      </div>

      <div id="registerForm" style="display: none;">
        <div class="form-group">
          <label>Nom complet</label>
          <input type="text" id="registerName" placeholder="Votre nom">
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="registerEmail" placeholder="votre@email.com">
        </div>
        <div class="form-group">
          <label>Mot de passe</label>
          <input type="password" id="registerPassword" placeholder="Créez un mot de passe">
        </div>
        <button class="btn btn-primary" id="registerBtn" onclick="register()">
          <span id="registerText">S'inscrire</span>
          <span id="registerLoader" class="loader" style="display: none;"></span>
        </button>
        <div class="separator">
          <span>ou</span>
        </div>
        <button class="btn btn-google" onclick="loginWithGoogle()">
          <i class="fab fa-google"></i>
          S'inscrire avec Google
        </button>
        <button class="btn btn-secondary" onclick="showLoginForm()">Déjà un compte ?</button>
        <div id="registerMessage" class="message" style="display: none;"></div>
      </div>
    </div>
  </div>

  <!-- Toast notifications -->
  <div id="toastContainer"></div>
</body>

<script>
  // Configuration Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyDppNy_hPeZnlFRlbwn8oeLZuhKU2vO8R0",
    authDomain: "collabnetwork-28hdst.firebaseapp.com",
    projectId: "collabnetwork-28hdst",
    storageBucket: "collabnetwork-28hdst.firebasestorage.app",
    messagingSenderId: "845662589845",
    appId: "1:845662589845:web:f4fe2c46ceac5bef409c9c",
    measurementId: "G-T8DS63CZYN"
  };

  // Initialisation Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // Variables globales
  let currentUser = null;
  let users = [];
  let currentMissionStep = 1;

  // Missions avec images et descriptions
  const missions = [
    {
      step: 1,
      title: "Sac à Dos Équipement",
      location: "Vieux Port de Marseille",
      description: "Votre premier équipement essentiel pour l'aventure",
      instructions: "Rendez-vous au Vieux Port de Marseille. Trouvez le point de collecte près de la grande roue. Le sac à dos est caché dans un coffre sécurisé.",
      image: "https://images.unsplash.com/photo-1552733407-5d5c46c3bb3b?w=800&h=400&fit=crop",
      objective: "Récupérer le sac à dos d'aventurier",
      qrCode: "HOLDEST_SAC_001",
      reward: 100
    },
    {
      step: 2,
      title: "Couteau de Survie",
      location: "Magasin de Sport Aventure",
      description: "Un outil essentiel pour votre survie en milieu urbain",
      instructions: "Direction le magasin de sport 'Aventure & Survie' au centre-ville. Présentez votre code participant pour récupérer votre couteau de survie professionnel.",
      image: "https://images.unsplash.com/photo-1558104631-0ed0302ee25e?w=800&h=400&fit=crop",
      objective: "Obtenir le couteau de survie certifié",
      qrCode: "HOLDEST_COUTEAU_002",
      reward: 150
    },
    {
      step: 3,
      title: "Approvisionnement en Eau",
      location: "Supermarché City Market",
      description: "L'eau est vitale pour survivre dans cette aventure",
      instructions: "Au supermarché City Market, récupérez votre pack de 6 bouteilles d'eau. Le code barre à scanner se trouve au rayon des boissons.",
      image: "https://images.unsplash.com/photo-1625602812206-5ec545ca1231?w=800&h=400&fit=crop",
      objective: "Scanner le code barre du pack d'eau",
      qrCode: "HOLDEST_EAU_003",
      reward: 200
    },
    {
      step: 4,
      title: "Ravitaillement en Nourriture",
      location: "Boucherie Traditionnelle",
      description: "Des protéines pour maintenir votre énergie",
      instructions: "La Boucherie Traditionnelle vous réserve 500g de viande séchée. Présentez-vous au comptoir avec votre code participant.",
      image: "https://images.unsplash.com/photo-1602546180234-2308c3e7fd1d?w=800&h=400&fit=crop",
      objective: "Récupérer la viande séchée",
      qrCode: "HOLDEST_VIANDE_004",
      reward: 250
    },
    {
      step: 5,
      title: "Défi Final - Mode Survie",
      location: "Parc des Calanques",
      description: "L'ultime épreuve de votre odyssée",
      instructions: "Rendez-vous au point de rendez-vous dans le parc. Vous devrez construire un abri, allumer un feu et prouver vos compétences en survie.",
      image: "https://images.unsplash.com/photo-1542273917363-3b1817f69a2d?w=800&h=400&fit=crop",
      objective: "Survivre 24h en autonomie complète",
      qrCode: "HOLDEST_FINAL_005",
      reward: 500
    }
  ];

  // Commerces partenaires
  const commercePartners = [
    {
      id: 1,
      name: "Boucherie Traditionnelle",
      type: "Boucherie",
      image: "https://images.unsplash.com/photo-1602546180234-2308c3e7fd1d?w=400&h=300&fit=crop",
      description: "Notre boucherie participe à l'aventure en fournissant de la viande séchée pour les aventuriers.",
      address: "123 Rue de la République, Marseille",
      mission: "Récupérer 500g de viande séchée",
      reward: "250 points + Certificat de ravitaillement"
    },
    {
      id: 2,
      name: "Supermarché City Market",
      type: "Alimentation",
      image: "https://images.unsplash.com/photo-1625602812206-5ec545ca1231?w=400&h=300&fit=crop",
      description: "Partenaire officiel pour l'approvisionnement en eau et denrées non périssables.",
      address: "456 Avenue du Commerce, Marseille",
      mission: "Obtenir un pack de 6 bouteilles d'eau",
      reward: "200 points + Kit hydratation"
    },
    {
      id: 3,
      name: "Magasin Aventure & Survie",
      type: "Sport",
      image: "https://images.unsplash.com/photo-1558104631-0ed0302ee25e?w=400&h=300&fit=crop",
      description: "Équipement professionnel de randonnée et survie. Partenaire technique officiel.",
      address: "789 Boulevard des Sports, Marseille",
      mission: "Récupérer le couteau de survie certifié",
      reward: "150 points + Guide de survie"
    }
  ];

  // Initialisation
  document.addEventListener('DOMContentLoaded', function() {
    console.log("Initialisation de l'application...");
    initApp();
    setupEventListeners();
    initAvatarSelection();
    loadCommercePartners();
    loadParticipants();
  });

  function initApp() {
    console.log("Initialisation de Firebase...");
    
    // Observer l'état d'authentification
    auth.onAuthStateChanged(async (user) => {
      console.log("État d'authentification changé:", user);
      if (user) {
        currentUser = user;
        console.log("Utilisateur connecté:", user.email);
        showToast(`Bienvenue ${user.displayName || user.email} !`, 'success');
        await loadUserData(user.uid);
        showPrivateApp();
      } else {
        console.log("Aucun utilisateur connecté");
        showPublicApp();
      }
    });
  }

  function setupEventListeners() {
    // Navigation
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const section = e.target.getAttribute('data-section');
        showSection(section);
      });
    });

    // Déconnexion
    document.getElementById('logoutBtn').addEventListener('click', logout);
    
    // Enter key pour les formulaires
    document.getElementById('loginPassword')?.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') login();
    });
    
    document.getElementById('registerPassword')?.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') register();
    });
  }

  async function loadUserData(userId) {
    console.log("Chargement des données utilisateur pour:", userId);
    try {
      const userDoc = await db.collection('users').doc(userId).get();
      if (userDoc.exists) {
        const userData = userDoc.data();
        console.log("Données utilisateur trouvées:", userData);
        updateUI(userData);
        updateMissionProgress(userData);
      } else {
        console.log("Aucun profil utilisateur trouvé, création d'un nouveau profil");
        await createUserProfile(userId);
      }
    } catch (error) {
      console.error("Erreur lors du chargement des données:", error);
      showToast("Erreur lors du chargement du profil", "error");
    }
  }

  async function createUserProfile(userId) {
    console.log("Création du profil utilisateur...");
    const userData = {
      displayName: currentUser.displayName || 'Aventurier',
      email: currentUser.email,
      avatar: availableAvatars[0],
      level: 1,
      points: 0,
      inventory: [],
      missionsCompleted: [],
      currentMission: 1,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    try {
      await db.collection('users').doc(userId).set(userData);
      console.log("Profil utilisateur créé avec succès");
      updateUI(userData);
      updateMissionProgress(userData);
      showToast("Profil créé avec succès!", "success");
    } catch (error) {
      console.error("Erreur lors de la création du profil:", error);
      showToast("Erreur lors de la création du profil", "error");
    }
  }

  function updateUI(userData) {
    console.log("Mise à jour de l'interface utilisateur");
    document.getElementById('userName').textContent = userData.displayName;
    document.getElementById('userAvatar').src = userData.avatar;
    document.getElementById('displayName').value = userData.displayName;
    document.getElementById('userLevel').textContent = `Niveau ${userData.level} - ${userData.points} points`;
    document.getElementById('missionsCompleted').textContent = userData.missionsCompleted?.length || 0;
    
    // Mettre à jour l'avatar sélectionné
    document.querySelectorAll('.avatar-option').forEach(avatar => {
      if (avatar.src === userData.avatar) {
        avatar.classList.add('selected');
      }
    });

    // Mettre à jour l'inventaire
    updateInventoryUI(userData.inventory);
  }

  function updateMissionProgress(userData) {
    const completedMissions = userData.missionsCompleted?.length || 0;
    const totalMissions = missions.length;
    const progress = (completedMissions / totalMissions) * 100;
    
    document.getElementById('globalProgress').style.width = `${progress}%`;
    document.getElementById('progressText').textContent = `${Math.round(progress)}% complété`;
    
    // Mettre à jour les étapes
    missions.forEach(mission => {
      const stepIcon = document.getElementById(`step${mission.step}Icon`);
      if (userData.missionsCompleted?.includes(mission.step)) {
        stepIcon.className = 'step-icon completed';
      } else if (mission.step === userData.currentMission) {
        stepIcon.className = 'step-icon active';
      } else {
        stepIcon.className = 'step-icon';
      }
    });
    
    // Afficher la mission actuelle
    displayCurrentMission(userData.currentMission || 1);
  }

  function displayCurrentMission(missionStep) {
    const mission = missions.find(m => m.step === missionStep);
    if (!mission) return;
    
    const missionContent = document.getElementById('missionContent');
    missionContent.innerHTML = `
      <h3>${mission.title}</h3>
      <p><strong>Lieu:</strong> ${mission.location}</p>
      <img src="${mission.image}" alt="${mission.title}" class="mission-image">
      
      <div class="mission-instructions">
        <h4>Instructions</h4>
        <p>${mission.instructions}</p>
        <p><strong>Objectif:</strong> ${mission.objective}</p>
        <p><strong>Récompense:</strong> ${mission.reward} points</p>
      </div>
      
      <div class="qr-scanner">
        <h4>Validation de la mission</h4>
        <p>Scannez le code QR sur place pour valider</p>
        <div class="qr-placeholder">
          <i class="fas fa-qrcode"></i>
        </div>
        <p>Code: ${mission.qrCode}</p>
        <button class="btn btn-primary" onclick="completeMission(${mission.step})">
          Valider la mission
        </button>
      </div>
    `;
  }

  async function completeMission(missionStep) {
    if (!currentUser) return;
    
    try {
      const mission = missions.find(m => m.step === missionStep);
      const userRef = db.collection('users').doc(currentUser.uid);
      const userDoc = await userRef.get();
      const userData = userDoc.data();
      
      // Vérifier si la mission est déjà complétée
      if (userData.missionsCompleted?.includes(missionStep)) {
        showToast("Mission déjà complétée!", "info");
        return;
      }
      
      // Mettre à jour l'utilisateur
      await userRef.update({
        missionsCompleted: firebase.firestore.FieldValue.arrayUnion(missionStep),
        currentMission: missionStep + 1,
        points: firebase.firestore.FieldValue.increment(mission.reward),
        inventory: firebase.firestore.FieldValue.arrayUnion(mission.title)
      });
      
      showToast(`Mission "${mission.title}" complétée! +${mission.reward} points`, "success");
      
      // Recharger les données utilisateur
      await loadUserData(currentUser.uid);
      
    } catch (error) {
      console.error("Erreur lors de la validation de la mission:", error);
      showToast("Erreur lors de la validation", "error");
    }
  }

  function updateInventoryUI(inventory) {
    const inventoryGrid = document.getElementById('inventoryGrid');
    if (!inventoryGrid) return;
    
    inventoryGrid.innerHTML = '';
    
    if (inventory && inventory.length > 0) {
      inventory.forEach(item => {
        const itemElement = document.createElement('div');
        itemElement.className = 'inventory-item';
        itemElement.innerHTML = `
          <i class="fas fa-box"></i>
          <div>${item}</div>
        `;
        inventoryGrid.appendChild(itemElement);
      });
    } else {
      inventoryGrid.innerHTML = '<p>Votre inventaire est vide. Complétez des missions pour le remplir!</p>';
    }
  }

  // Toast notifications
  function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
      <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
      <span>${message}</span>
    `;
    
    toastContainer.appendChild(toast);
    
    // Afficher le toast
    setTimeout(() => toast.classList.add('show'), 100);
    
    // Cacher et supprimer le toast après 5 secondes
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => {
        if (toast.parentNode) {
          toast.parentNode.removeChild(toast);
        }
      }, 300);
    }, 5000);
  }

  // Authentification
  function showLoginForm() {
    document.getElementById('loginForm').style.display = 'block';
    document.getElementById('registerForm').style.display = 'none';
    hideAuthMessages();
  }

  function showRegisterForm() {
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('registerForm').style.display = 'block';
    hideAuthMessages();
  }

  function hideAuthMessages() {
    document.getElementById('authMessage').style.display = 'none';
    document.getElementById('registerMessage').style.display = 'none';
  }

  function showAuthMessage(message, type) {
    const element = document.getElementById('authMessage');
    element.textContent = message;
    element.className = `message ${type}`;
    element.style.display = 'block';
  }

  function showRegisterMessage(message, type) {
    const element = document.getElementById('registerMessage');
    element.textContent = message;
    element.className = `message ${type}`;
    element.style.display = 'block';
  }

  function setLoginLoading(loading) {
    const loginText = document.getElementById('loginText');
    const loginLoader = document.getElementById('loginLoader');
    const loginBtn = document.getElementById('loginBtn');
    
    if (loading) {
      loginText.style.display = 'none';
      loginLoader.style.display = 'inline-block';
      loginBtn.disabled = true;
    } else {
      loginText.style.display = 'inline-block';
      loginLoader.style.display = 'none';
      loginBtn.disabled = false;
    }
  }

  function setRegisterLoading(loading) {
    const registerText = document.getElementById('registerText');
    const registerLoader = document.getElementById('registerLoader');
    const registerBtn = document.getElementById('registerBtn');
    
    if (loading) {
      registerText.style.display = 'none';
      registerLoader.style.display = 'inline-block';
      registerBtn.disabled = true;
    } else {
      registerText.style.display = 'inline-block';
      registerLoader.style.display = 'none';
      registerBtn.disabled = false;
    }
  }

  async function login() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    
    if (!email || !password) {
      showAuthMessage('Veuillez remplir tous les champs', 'error');
      return;
    }
    
    try {
      setLoginLoading(true);
      showAuthMessage('Connexion en cours...', 'success');
      await auth.signInWithEmailAndPassword(email, password);
        // Le popup se fermera automatiquement via onAuthStateChanged
    } catch (error) {
      console.error('Erreur d\'inscription:', error);
      let message = 'Erreur lors de la création du compte';
      if (error.code === 'auth/email-already-in-use') {
        message = 'Un compte existe déjà avec cet email';
      } else if (error.code === 'auth/invalid-email') {
        message = 'Email invalide';
      } else if (error.code === 'auth/weak-password') {
        message = 'Le mot de passe est trop faible';
      }
      showRegisterMessage(message, 'error');
    } finally {
      setRegisterLoading(false);
    }
  }

  async function loginWithGoogle() {
    try {
      const provider = new firebase.auth.GoogleAuthProvider();
      await auth.signInWithPopup(provider);
      // La redirection se fera automatiquement via onAuthStateChanged
    } catch (error) {
      console.error('Erreur de connexion Google:', error);
      showToast('Erreur lors de la connexion avec Google', 'error');
    }
  }

  function logout() {
    auth.signOut();
    showToast('Vous êtes déconnecté', 'info');
  }

  // Navigation
  function showSection(sectionId) {
    console.log("Changement de section vers:", sectionId);
    // Masquer toutes les sections
    document.querySelectorAll('.section').forEach(section => {
      section.classList.remove('active');
    });
    
    // Désactiver tous les liens de navigation
    document.querySelectorAll('.nav-link').forEach(link => {
      link.classList.remove('active');
    });
    
    // Afficher la section sélectionnée
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
      targetSection.classList.add('active');
    }
    
    // Activer le lien correspondant
    const targetLink = document.querySelector(`[data-section="${sectionId}"]`);
    if (targetLink) {
      targetLink.classList.add('active');
    }
  }

  function showPrivateApp() {
    console.log("Affichage de l'application privée");
    document.getElementById('publicApp').style.display = 'none';
    document.getElementById('privateApp').style.display = 'block';
    document.getElementById('authPopup').style.display = 'none';
    showSection('home');
  }

  function showPublicApp() {
    console.log("Affichage de l'application publique");
    document.getElementById('publicApp').style.display = 'flex';
    document.getElementById('privateApp').style.display = 'none';
  }

  function showAuthPopup() {
    console.log("Affichage du popup d'authentification");
    document.getElementById('authPopup').style.display = 'flex';
    
    // Réinitialiser les formulaires
    document.getElementById('loginEmail').value = '';
    document.getElementById('loginPassword').value = '';
    document.getElementById('registerName').value = '';
    document.getElementById('registerEmail').value = '';
    document.getElementById('registerPassword').value = '';
    hideAuthMessages();
    showLoginForm();
  }

  // Gestion des avatars
  const availableAvatars = [
    'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=150&h=150&fit=crop&crop=face',
    'https://images.unsplash.com/photo-1494790108755-2616b612b786?w=150&h=150&fit=crop&crop=face',
    'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=150&h=150&fit=crop&crop=face',
    'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=150&h=150&fit=crop&crop=face',
    'https://images.unsplash.com/photo-1544725176-7c40e5a71c5e?w=150&h=150&fit=crop&crop=face',
    'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=150&h=150&fit=crop&crop=face'
  ];

  function initAvatarSelection() {
    const avatarGrid = document.getElementById('avatarGrid');
    if (!avatarGrid) return;
    
    avatarGrid.innerHTML = '';
    availableAvatars.forEach((avatar, index) => {
      const img = document.createElement('img');
      img.src = avatar;
      img.className = 'avatar-option';
      img.addEventListener('click', () => selectAvatar(avatar));
      avatarGrid.appendChild(img);
    });
  }

  async function selectAvatar(avatarUrl) {
    if (!currentUser) return;
    
    // Mettre à jour l'interface
    document.querySelectorAll('.avatar-option').forEach(avatar => {
      avatar.classList.remove('selected');
    });
    event.target.classList.add('selected');
    
    // Mettre à jour dans Firebase
    try {
      await db.collection('users').doc(currentUser.uid).update({
        avatar: avatarUrl
      });
      
      // Mettre à jour l'interface utilisateur
      document.getElementById('userAvatar').src = avatarUrl;
      console.log("Avatar mis à jour avec succès");
      showToast("Avatar mis à jour avec succès!", "success");
    } catch (error) {
      console.error("Erreur lors de la mise à jour de l'avatar:", error);
      showToast("Erreur lors de la mise à jour de l'avatar", "error");
    }
  }

  async function updateProfile() {
    const displayName = document.getElementById('displayName').value;
    
    if (!currentUser || !displayName) {
      showToast("Veuillez entrer un nom d'aventurier", "error");
      return;
    }
    
    try {
      await db.collection('users').doc(currentUser.uid).update({
        displayName: displayName
      });
      
      // Mettre à jour l'interface
      document.getElementById('userName').textContent = displayName;
      
      console.log("Profil mis à jour avec succès");
      showToast("Profil mis à jour avec succès!", "success");
    } catch (error) {
      console.error("Erreur lors de la mise à jour du profil:", error);
      showToast("Erreur lors de la mise à jour du profil", "error");
    }
  }

  // Participants
  function loadParticipants() {
    const participantsGrid = document.getElementById('participantsGrid');
    if (!participantsGrid) return;
    
    // Pour l'instant, nous affichons des participants fictifs
    // Dans une vraie application, vous chargeriez cela depuis Firebase
    participantsGrid.innerHTML = `
      <div class="participant-card">
        <img src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=150&h=150&fit=crop&crop=face" class="participant-avatar">
        <h4>Alexandre</h4>
        <div class="user-level">Niveau 3 - 450 points</div>
        <div class="mission-progress">3/5 missions</div>
      </div>
      <div class="participant-card">
        <img src="https://images.unsplash.com/photo-1494790108755-2616b612b786?w=150&h=150&fit=crop&crop=face" class="participant-avatar">
        <h4>Sophie</h4>
        <div class="user-level">Niveau 2 - 300 points</div>
        <div class="mission-progress">2/5 missions</div>
      </div>
      <div class="participant-card">
        <img src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=150&h=150&fit=crop&crop=face" class="participant-avatar">
        <h4>Thomas</h4>
        <div class="user-level">Niveau 4 - 600 points</div>
        <div class="mission-progress">4/5 missions</div>
      </div>
      <div class="participant-card">
        <img src="https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=150&h=150&fit=crop&crop=face" class="participant-avatar">
        <h4>Marie</h4>
        <div class="user-level">Niveau 1 - 100 points</div>
        <div class="mission-progress">1/5 missions</div>
      </div>
    `;
  }

  // Commerces partenaires
  function loadCommercePartners() {
    const partnersGrid = document.getElementById('partnersGrid');
    if (!partnersGrid) return;
    
    partnersGrid.innerHTML = '';
    commercePartners.forEach(partner => {
      const partnerCard = document.createElement('div');
      partnerCard.className = 'partner-card';
      partnerCard.innerHTML = `
        <img src="${partner.image}" alt="${partner.name}" class="partner-image">
        <div class="partner-info">
          <span class="partner-badge">${partner.type}</span>
          <h3>${partner.name}</h3>
          <p>${partner.description}</p>
          <p><strong>Adresse:</strong> ${partner.address}</p>
          <p><strong>Mission:</strong> ${partner.mission}</p>
          <p><strong>Récompense:</strong> ${partner.reward}</p>
          <button class="btn btn-primary" onclick="startCommerceMission('${partner.name}')">
            Voir les détails
          </button>
        </div>
      `;
      partnersGrid.appendChild(partnerCard);
    });
  }

  function startCommerceMission(commerceName) {
    showToast(`Mission chez ${commerceName} - Rendez-vous sur place avec votre code participant!`, "success");
  }

  // Initialisation des avatars au chargement
  window.onload = function() {
    console.log("Page complètement chargée");
    // L'initialisation se fait déjà dans DOMContentLoaded
  };
</script>

<style>
  .separator {
    display: flex;
    align-items: center;
    text-align: center;
    margin: 20px 0;
    color: var(--medium-text);
  }
  
  .separator::before,
  .separator::after {
    content: '';
    flex: 1;
    border-bottom: 1px solid var(--medium-text);
  }
  
  .separator:not(:empty)::before {
    margin-right: .25em;
  }
  
  .separator:not(:empty)::after {
    margin-left: .25em;
  }
  
  .mission-progress {
    font-size: 0.8rem;
    color: var(--primary-color);
    margin-top: 5px;
  }
</style>
</html>
